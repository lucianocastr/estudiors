// Prisma Schema — Estudio Jurídico RS
// Legal CRM v2.0 — Arquitectura revisada
// Contact(1) → Inquiry(N), Organization, InquiryAssignment, InquiryEvent, soft delete, índices

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum MemberRole {
  OWNER
  ADMIN
  PROFESIONAL
  ASISTENTE
}

enum InquiryEstado {
  NUEVA
  EN_ANALISIS
  CONTACTADO
  CONVERTIDO
  CERRADO
}

enum InquiryPrioridad {
  BAJA
  NORMAL
  ALTA
  URGENTE
}

enum FuenteCaptacion {
  WEB
  INSTAGRAM
  WHATSAPP
  REFERIDO
  OTRO
}

enum Modalidad {
  PRESENCIAL
  VIRTUAL
}

enum AppointmentEstado {
  PENDIENTE
  CONFIRMADO
  RECHAZADO
  COMPLETADO
  CANCELADO
}

enum NotaTipo {
  GENERAL
  LLAMADA
  REUNION
  SEGUIMIENTO
  SISTEMA
}

enum EventTipo {
  CREATED
  STATE_CHANGED
  ASSIGNED
  REASSIGNED
  NOTE_ADDED
  NOTE_DELETED
  APPOINTMENT_CREATED
  APPOINTMENT_CONFIRMED
  APPOINTMENT_REJECTED
  APPOINTMENT_COMPLETED
  CONTACT_ATTEMPT
  CLIENT_CONVERTED
  CLOSED
}

enum EmailEstado {
  PENDIENTE
  PROCESANDO
  ENVIADO
  FALLIDO
  CANCELADO
}

enum OrganizacionPlan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

// ============================================
// ORGANIZACIÓN — Tenant root
// ============================================

model Organizacion {
  id            String           @id @default(cuid())
  nombre        String
  slug          String           @unique
  plan          OrganizacionPlan @default(FREE)
  activa        Boolean          @default(true)
  configuracion Json?

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  deletedAt     DateTime?

  miembros             OrganizacionMiembro[]
  contactos            Contacto[]
  consultas            Consulta[]
  asignaciones         ConsultaAsignacion[]
  eventos              ConsultaEvento[]
  turnos               Turno[]
  notas                Nota[]
  emailCola            EmailCola[]
  configuraciones      Configuracion[]
  casosRestructuracion CasoRestructuracion[]

  @@index([slug])
  @@index([deletedAt])
}

// ============================================
// USUARIO — Sistema (NextAuth)
// ============================================

model Usuario {
  id        String     @id @default(cuid())
  email     String     @unique
  nombre    String
  imagen    String?
  rol       MemberRole @default(PROFESIONAL) // Rol global del sistema
  titulo    String?    // "Dra.", "Dr.", "Abogado/a"
  matricula String?
  bio       String?
  telefono  String?
  activo    Boolean    @default(true)

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  deletedAt DateTime?

  membresias            OrganizacionMiembro[]
  notasCreadas          Nota[]
  asignacionesHechas    ConsultaAsignacion[]  @relation("AsignadoPor")
  asignacionesRecibidas ConsultaAsignacion[]  @relation("AsignadoA")
  eventosCreados        ConsultaEvento[]
  bloqueosHorario       BloqueoHorario[]
  casosResponsable      CasoRestructuracion[] @relation("CasosResponsable")
  intervencionesCRP     IntervencionCRP[]     @relation("IntervencionesCreadas")
  alertasCRP            AlertaCRP[]           @relation("AlertasAsignadas")

  @@index([email])
  @@index([deletedAt])
}

// ============================================
// MEMBRESÍA — Rol por organización
// ============================================

model OrganizacionMiembro {
  id             String       @id @default(cuid())
  organizacionId String
  organizacion   Organizacion @relation(fields: [organizacionId], references: [id])
  usuarioId      String
  usuario        Usuario      @relation(fields: [usuarioId], references: [id])
  rol            MemberRole   @default(PROFESIONAL)
  permisos       Json?        // Overrides futuros por campo
  activo         Boolean      @default(true)

  createdAt      DateTime     @default(now())
  deletedAt      DateTime?

  @@unique([organizacionId, usuarioId])
  @@index([organizacionId])
  @@index([usuarioId])
  @@index([organizacionId, rol])
}

// ============================================
// CONTACTO — Persona (1 → N consultas)
// ============================================

model Contacto {
  id             String          @id @default(cuid())
  organizacionId String
  organizacion   Organizacion    @relation(fields: [organizacionId], references: [id])

  // Datos personales
  nombre         String
  email          String
  telefono       String
  localidad      String?
  documentoTipo  String?         // DNI | CUIL | Pasaporte
  documentoNro   String?

  // CRM
  fuente         FuenteCaptacion @default(WEB)
  tags           String[]

  // Escalón hacia entidad Client (Fase 3)
  esCliente      Boolean         @default(false)
  clienteDesdeAt DateTime?       // Se popula cuando primera consulta convierte

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  deletedAt      DateTime?

  consultas            Consulta[]
  casosRestructuracion CasoRestructuracion[]

  @@index([organizacionId])
  @@index([organizacionId, email])  // Deduplicación
  @@index([esCliente])
  @@index([deletedAt])
}

// ============================================
// CONSULTA / INQUIRY — Caso (pertenece a Contacto)
// ============================================

model Consulta {
  id             String           @id @default(cuid())
  organizacionId String
  organizacion   Organizacion     @relation(fields: [organizacionId], references: [id])
  contactoId     String
  contacto       Contacto         @relation(fields: [contactoId], references: [id])

  // Datos del caso
  especialidad    String
  tipoProblema    String
  descripcion     String           @db.Text
  urgente         Boolean          @default(false)
  prioridad       InquiryPrioridad @default(NORMAL)

  // CRM
  estado          InquiryEstado    @default(NUEVA)

  // Legal
  aceptaTerminos  Boolean          @default(false)
  disclaimerLeido Boolean          @default(false)

  // Timestamps de conversión — para métricas de embudo
  contactadoAt    DateTime?        // STATE → CONTACTADO
  convertidoAt    DateTime?        // STATE → CONVERTIDO
  cerradoAt       DateTime?        // STATE → CERRADO

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  deletedAt       DateTime?

  asignaciones    ConsultaAsignacion[]
  eventos         ConsultaEvento[]
  notas           Nota[]
  turno           Turno?

  @@index([organizacionId])
  @@index([contactoId])
  @@index([organizacionId, estado])
  @@index([organizacionId, urgente])
  @@index([organizacionId, prioridad])
  @@index([createdAt])
  @@index([deletedAt])
}

// ============================================
// ASIGNACIÓN — Historial completo por consulta
// ============================================

model ConsultaAsignacion {
  id             String       @id @default(cuid())
  consultaId     String
  consulta       Consulta     @relation(fields: [consultaId], references: [id])
  organizacionId String
  organizacion   Organizacion @relation(fields: [organizacionId], references: [id])

  asignadoAId    String
  asignadoA      Usuario      @relation("AsignadoA", fields: [asignadoAId], references: [id])
  asignadoPorId  String
  asignadoPor    Usuario      @relation("AsignadoPor", fields: [asignadoPorId], references: [id])

  activo         Boolean      @default(true)   // Solo 1 activo por consulta
  nota           String?

  createdAt      DateTime     @default(now())
  reasignadoAt   DateTime?    // Cuándo fue reemplazado

  @@index([consultaId])
  @@index([asignadoAId])
  @@index([consultaId, activo])  // Asignación actual eficiente
  @@index([organizacionId])
}

// ============================================
// EVENTO — Audit log append-only (nunca se modifica)
// ============================================

model ConsultaEvento {
  id             String       @id @default(cuid())
  consultaId     String
  consulta       Consulta     @relation(fields: [consultaId], references: [id])
  organizacionId String
  organizacion   Organizacion @relation(fields: [organizacionId], references: [id])

  autorId        String?      // null = acción del sistema
  autor          Usuario?     @relation(fields: [autorId], references: [id])

  tipo           EventTipo
  estadoAnterior String?
  estadoNuevo    String?
  metadata       Json?        // Datos adicionales flexibles

  createdAt      DateTime     @default(now()) // Sin updatedAt — inmutable

  @@index([consultaId])
  @@index([consultaId, tipo])
  @@index([organizacionId, createdAt])
}

// ============================================
// TURNO / APPOINTMENT
// ============================================

model Turno {
  id             String            @id @default(cuid())
  consultaId     String            @unique
  consulta       Consulta          @relation(fields: [consultaId], references: [id])
  organizacionId String
  organizacion   Organizacion      @relation(fields: [organizacionId], references: [id])

  // Preferencia del cliente
  modalidad        Modalidad
  fechaPreferida   DateTime
  horarioPreferido String            // "manana" | "tarde"

  // Gestión
  estado           AppointmentEstado @default(PENDIENTE)
  fechaConfirmada  DateTime?
  linkVideoCall    String?
  motivoRechazo    String?
  asistio          Boolean?          // null = sin evaluar aún

  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  deletedAt        DateTime?

  @@index([organizacionId])
  @@index([organizacionId, estado])
  @@index([fechaConfirmada])
  @@index([deletedAt])
}

// ============================================
// NOTA — Interna por consulta
// ============================================

model Nota {
  id             String       @id @default(cuid())
  consultaId     String
  consulta       Consulta     @relation(fields: [consultaId], references: [id])
  autorId        String
  autor          Usuario      @relation(fields: [autorId], references: [id])
  organizacionId String
  organizacion   Organizacion @relation(fields: [organizacionId], references: [id])

  contenido      String       @db.Text
  tipo           NotaTipo     @default(GENERAL)
  esPrivada      Boolean      @default(true)

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deletedAt      DateTime?

  @@index([consultaId])
  @@index([autorId])
  @@index([consultaId, deletedAt])  // Notas activas de una consulta
}

// ============================================
// EMAIL COLA — Servicio desacoplado
// ============================================

model EmailCola {
  id             String       @id @default(cuid())
  organizacionId String?
  organizacion   Organizacion? @relation(fields: [organizacionId], references: [id])

  destinatario   String
  asunto         String
  template       String       // Identificador de plantilla
  payload        Json         // Datos para la plantilla
  prioridad      Int          @default(5) // 1=alta, 10=baja

  estado         EmailEstado  @default(PENDIENTE)
  intentos       Int          @default(0)
  maxIntentos    Int          @default(3)
  proximoIntento DateTime?    // Backoff exponencial
  errorUltimo    String?
  procesadoAt    DateTime?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([estado, proximoIntento]) // Cola del worker
  @@index([organizacionId])
}

// ============================================
// BLOQUEO DE HORARIOS — Agenda
// ============================================

model BloqueoHorario {
  id             String   @id @default(cuid())
  usuarioId      String
  usuario        Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  organizacionId String?

  fechaInicio    DateTime
  fechaFin       DateTime
  motivo         String?

  createdAt      DateTime @default(now())

  @@index([usuarioId])
  @@index([fechaInicio, fechaFin])
}

// ============================================
// CONFIGURACIÓN — Key/value por organización
// ============================================

model Configuracion {
  id             String       @id @default(cuid())
  organizacionId String?
  organizacion   Organizacion? @relation(fields: [organizacionId], references: [id])
  clave          String
  valor          String       @db.Text
  tipo           String       @default("text") // "text" | "json" | "html"

  updatedAt      DateTime     @updatedAt

  @@unique([organizacionId, clave])
}

// ============================================
// CRP — ENUMS (prefijo CRP para evitar colisiones)
// ============================================

// ── Caso ──────────────────────────────────────────────────────────────────────

enum CRPEstadoCaso {
  DIAGNOSTICO
  EN_ANALISIS
  ESTRATEGIA
  NEGOCIACION
  IMPLEMENTACION
  JUDICIAL
  SUSPENDIDO
  CERRADO_EXITOSO
  CERRADO_ABANDONADO
  ARCHIVADO
}

enum CRPNivelUrgencia {
  BAJO
  MEDIO
  ALTO
  CRITICO
}

enum CRPNivelExposicion {
  BAJO
  MEDIO
  ALTO
  TOTAL
}

enum CRPObjetivoCliente {
  SALIR_RAPIDO
  MINIMIZAR_COSTO
  PROTEGER_BIENES
  MIXTO
}

enum CRPSituacionLaboral {
  RELACION_DEPENDENCIA
  AUTONOMO
  DESOCUPADO
  JUBILADO
  OTRO
}

enum CRPNivelSocioeconomico {
  BAJO
  MEDIO
  MEDIO_ALTO
  ALTO
}

enum CRPSituacionBCRA {
  NORMAL        // Situación 1
  RIESGO_BAJO   // Situación 2
  DEFICIENTE    // Situación 3
  DUDOSO        // Situación 4
  IRRECUPERABLE // Situación 5
}

enum CRPEstadoInhibicion {
  SIN_INHIBICION
  VIGENTE
  EN_GESTION_LEVANTAMIENTO
  LEVANTADA
}

// ── Deuda ─────────────────────────────────────────────────────────────────────

enum CRPTipoDeuda {
  TARJETA
  PRESTAMO_PERSONAL
  DESCUBIERTO
  HIPOTECA
  PRENDA
  OTRO
}

enum CRPEstadoDeuda {
  ACTIVA
  EN_NEGOCIACION
  PROPUESTA_ENVIADA
  CONTRAOFERTA_RECIBIDA
  ACUERDO_VERBAL
  ACUERDO_FORMALIZADO
  EN_CUMPLIMIENTO
  JUDICIALIZADA
  CERRADA
  ABANDONADA
}

enum CRPRiesgoJudicial {
  NULO
  BAJO
  MEDIO
  ALTO
  INMINENTE
}

enum CRPEstadoPrescricion {
  VIGENTE
  PROXIMA       // < 90 días → alerta automática CRITICA
  PRESCRIPTA
  INTERRUMPIDA
  SUSPENDIDA
}

enum CRPEstadoMediacion {
  NO_APLICA
  NO_INICIADA
  NOTIFICADA
  EN_CURSO
  ACUERDO
  FRACASADA
}

// ── Patrimonio ────────────────────────────────────────────────────────────────

enum CRPTipoBien {
  INMUEBLE
  VEHICULO
  FONDO_COMERCIO
  CREDITO_A_FAVOR
  BIEN_MUEBLE_REGISTRABLE
  OTRO
}

enum CRPRiesgoRevocatoria {
  NULO
  BAJO
  MEDIO
  ALTO
}

// ── Escenarios ────────────────────────────────────────────────────────────────

enum CRPTipoEscenario {
  REFINANCIAR
  PRESTAMO_EXTERNO
  ESPERAR_QUITA
  VENDER_ACTIVO
  IMPUGNAR_INTERESES
  CONCURSO_PREVENTIVO
  ACUERDO_EXTRAJUDICIAL
  COMBINADO
}

enum CRPEstadoEscenario {
  BORRADOR
  PRESENTADO
  ACEPTADO
  DESCARTADO
}

enum CRPRiesgoEscenario {
  BAJO
  MEDIO
  ALTO
}

// ── Intervenciones ────────────────────────────────────────────────────────────

enum CRPTipoIntervencion {
  LLAMADA
  REUNION
  PROPUESTA_ENVIADA
  CONTRAOFERTA_RECIBIDA
  DOCUMENTO_ENVIADO
  RESPUESTA_BANCO
  AUDIENCIA_MEDIACION
  PRESENTACION_JUDICIAL
  NOTA_INTERNA
  OTRO
}

// ── Honorarios ────────────────────────────────────────────────────────────────

enum CRPTipoServicio {
  CONSULTA
  DIAGNOSTICO
  NEGOCIACION
  LITIGIO
  COMBINADO
}

enum CRPEstadoPago {
  PENDIENTE
  PARCIAL
  PAGADO
  INCOBRABLE
}

// ── Alertas ───────────────────────────────────────────────────────────────────

enum CRPTipoAlerta {
  PRESCRIPCION_PROXIMA
  PRESCRIPCION_VENCIDA
  AUDIENCIA_MEDIACION
  VENCIMIENTO_PROPUESTA
  FOLLOW_UP
  REVISION_CASO
  HONORARIO_VENCIDO
  INHIBICION_ACTIVA
  CUSTOM
}

enum CRPPrioridadAlerta {
  BAJA
  MEDIA
  ALTA
  CRITICA
}

enum CRPEstadoAlerta {
  PENDIENTE
  VISTA
  RESUELTA
  DESCARTADA
}

// ============================================
// CRP — MODELOS
// ============================================

model CasoRestructuracion {
  id             String   @id @default(cuid())
  numeroCaso     String   @unique // "CRP-2024-0001"
  organizacionId String
  contactoId     String
  abogadoId      String

  // Clasificación estratégica
  estado              CRPEstadoCaso      @default(DIAGNOSTICO)
  nivelUrgencia       CRPNivelUrgencia   @default(MEDIO)
  nivelExposicion     CRPNivelExposicion @default(MEDIO)
  objetivoCliente     CRPObjetivoCliente?
  situacionLaboral    CRPSituacionLaboral?
  nivelSocioeconomico CRPNivelSocioeconomico?

  // Datos financiero-legales del cliente
  cuit          String?
  estadoBCRA    CRPSituacionBCRA?
  historialBCRA Json? // [{ fecha: string, situacion: string, entidad: string }]

  // Inhibición general de bienes
  estadoInhibicion   CRPEstadoInhibicion @default(SIN_INHIBICION)
  juzgadoInhibicion  String?
  acreedorInhibicion String?
  fechaInhibicion    DateTime?

  // Diagnóstico y estrategia
  // JSON con keys: prescripcionRevisada, cesionVerificada, interesesEvaluados,
  // mediacionNotificada, inhibicionConsultada, revocatoriaEvaluada,
  // bienFamiliaInscripto, codeudoresIdentificados, ingresoFormal
  checklistDiagnostico Json?
  recomendacionTecnica String? @db.Text

  // Ciclo de vida
  fechaApertura DateTime  @default(now())
  fechaCierre   DateTime?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relaciones
  organizacion Organizacion  @relation(fields: [organizacionId], references: [id])
  contacto     Contacto      @relation(fields: [contactoId], references: [id])
  abogado      Usuario       @relation("CasosResponsable", fields: [abogadoId], references: [id])

  deudas              DeudaBancaria[]
  bienes              BienPatrimonial[]
  analisisFinancieros AnalisisFinanciero[]
  escenarios          EscenarioEstrategico[]
  intervenciones      IntervencionCRP[]
  honorarios          HonorarioCRP[]
  alertas             AlertaCRP[]

  @@index([organizacionId])
  @@index([organizacionId, estado])
  @@index([contactoId])
  @@index([abogadoId])
  @@index([organizacionId, nivelUrgencia])
  @@index([deletedAt])
}

model DeudaBancaria {
  id     String @id @default(cuid())
  casoId String

  // Acreedor — separado para cubrir cesión de cartera
  acreedorOriginal         String
  acreedorActual           String
  fueCedida                Boolean  @default(false)
  fechaCesion              DateTime?
  notificacionCesionValida Boolean? // ¿el cliente fue notificado válidamente?

  // Caracterización
  tipoDeuda   CRPTipoDeuda
  estadoDeuda CRPEstadoDeuda  @default(ACTIVA)
  situacionBCRA CRPSituacionBCRA?
  fechaMora   DateTime?
  // diasMora → calculado en runtime

  // Composición económica completa
  capitalOriginal        Decimal @db.Decimal(14, 2)
  capitalActual          Decimal @db.Decimal(14, 2)
  interesesAcumulados    Decimal @db.Decimal(14, 2) @default(0)
  punitatorios           Decimal @db.Decimal(14, 2) @default(0)
  totalReclamado         Decimal @db.Decimal(14, 2) // capital + intereses + punit.
  costasJudiciales       Decimal @db.Decimal(14, 2) @default(0)
  honorariosAbogadoBanco Decimal @db.Decimal(14, 2) @default(0)
  // totalConCostas → calculado: totalReclamado + costas + honorariosAbogadoBanco

  // Prescripción — variable estratégica crítica
  plazoPrescricionMeses Int?              // TARJETA=36, PRESTAMO=60, HIPOTECA=120
  fechaInicioComputo    DateTime?         // generalmente = fechaMora
  fechaPrescricion      DateTime?         // calculado al guardar
  estadoPrescricion     CRPEstadoPrescricion @default(VIGENTE)
  causaInterrupcion     String?           // "Demanda iniciada 15/03/2023"

  // Riesgo y negociación
  riesgoJudicial          CRPRiesgoJudicial @default(BAJO)
  escenarioQuitaEstimado  Decimal?          @db.Decimal(5, 2) // % de quita
  propuestaRefinanciacion String?           @db.Text
  montoAcordado           Decimal?          @db.Decimal(14, 2)

  // Mediación prejudicial con fechas para alertas automáticas
  estadoMediacion      CRPEstadoMediacion @default(NO_APLICA)
  fechaNotificacionMed DateTime?
  fechaAudienciaMed    DateTime?          // → genera alerta AUDIENCIA_MEDIACION CRITICA
  resultadoMediacion   String?

  // Expediente judicial
  nroExpedienteJudicial String?
  juzgado               String?
  fuero                 String? // "Comercial" / "Civil" / "Federal"
  abogadoBanco          String?

  observaciones String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  caso           CasoRestructuracion  @relation(fields: [casoId], references: [id])
  intervenciones IntervencionCRP[]
  alertas        AlertaCRP[]
  escenarios     EscenarioDeuda[]

  @@index([casoId])
  @@index([casoId, estadoDeuda])
  @@index([casoId, estadoPrescricion])
  @@index([fechaAudienciaMed])
  @@index([fechaPrescricion])
}

model BienPatrimonial {
  id     String @id @default(cuid())
  casoId String

  tipo          CRPTipoBien
  descripcion   String
  valorEstimado Decimal @db.Decimal(14, 2)

  // Características jurídicas
  esRegistrable Boolean @default(false)
  esEmbargable  Boolean @default(true)
  esBienFamilia Boolean @default(false) // vivienda única inscripta → inembargable

  // Cargas y garantías
  tieneGarantia Boolean @default(false)
  garantiaTipo  String?
  tienePrenda   Boolean @default(false)
  tieneCodeudor Boolean @default(false)
  codeudorNombre String?

  // Riesgo de acción revocatoria (Arts. 338-342 CCCN)
  riesgoRevocatoria       CRPRiesgoRevocatoria @default(NULO)
  motivoRiesgoRevocatoria String?

  observaciones String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  caso      CasoRestructuracion  @relation(fields: [casoId], references: [id])
  escenarios EscenarioDeuda[]

  @@index([casoId])
  @@index([casoId, tipo])
}

model AnalisisFinanciero {
  id        String @id @default(cuid())
  casoId    String
  version   Int    @default(1)

  // Flujo mensual
  ingresoMensualNeto      Decimal @db.Decimal(14, 2)
  egresosFijos            Decimal @db.Decimal(14, 2) @default(0)
  compromisoMensualDeudas Decimal @db.Decimal(14, 2) @default(0)
  // flujoDisponible = ingresoMensualNeto - egresosFijos - compromisoMensualDeudas
  // ratioDeudaIngreso = totalPasivosBruto / (ingresoMensualNeto * 12)

  // Snapshot de pasivos al momento del análisis
  totalPasivosBruto     Decimal @db.Decimal(14, 2) // suma capitalActual
  totalPasivosReclamado Decimal @db.Decimal(14, 2) // suma totalReclamado
  totalConCostas        Decimal @db.Decimal(14, 2) // suma totalConCostas

  // Snapshot de activos
  totalActivosEstimados Decimal @db.Decimal(14, 2)
  // patrimonioNeto = totalActivosEstimados - totalPasivosBruto

  // Capacidad de pago
  capacidadPagoMensual Decimal @db.Decimal(14, 2)
  mesesParaRegularizar Int?

  observaciones String? @db.Text

  // Append-only: solo createdAt, sin updatedAt
  fechaAnalisis DateTime @default(now())
  createdAt     DateTime @default(now())

  caso CasoRestructuracion @relation(fields: [casoId], references: [id])

  @@unique([casoId, version])
  @@index([casoId])
}

model EscenarioEstrategico {
  id     String @id @default(cuid())
  casoId String

  nombre        String
  tipoEscenario CRPTipoEscenario
  descripcion   String?          @db.Text
  estado        CRPEstadoEscenario @default(BORRADOR)

  // Números del escenario
  montoTotalPagar      Decimal  @db.Decimal(14, 2)
  // ahorroVsReclamado → calculado runtime
  plazoMeses           Int?
  cuotaMensualEstimada Decimal? @db.Decimal(14, 2)

  // Evaluación
  riesgoEscenario CRPRiesgoEscenario @default(MEDIO)
  ventajas        String?            @db.Text
  desventajas     String?            @db.Text

  // Decisión
  recomendado       Boolean   @default(false) // marcado por abogado
  seleccionado      Boolean   @default(false) // aprobado por cliente
  fechaPresentacion DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  caso          CasoRestructuracion @relation(fields: [casoId], references: [id])
  deudasYBienes EscenarioDeuda[]

  @@index([casoId])
  @@index([casoId, estado])
}

// Pivot M:N: escenario ↔ deudas y bienes involucrados
model EscenarioDeuda {
  id          String @id @default(cuid())
  escenarioId String
  deudaId     String?
  bienId      String?
  rol         String? // "deuda principal" / "bien a vender" / "garantía"

  escenario EscenarioEstrategico @relation(fields: [escenarioId], references: [id])
  deuda     DeudaBancaria?       @relation(fields: [deudaId], references: [id])
  bien      BienPatrimonial?     @relation(fields: [bienId], references: [id])

  @@index([escenarioId])
  @@index([deudaId])
  @@index([bienId])
}

model IntervencionCRP {
  id      String @id @default(cuid())
  casoId  String
  deudaId String?
  usuarioId String

  tipoIntervencion   CRPTipoIntervencion
  fecha              DateTime
  entidadInvolucrada String? // banco, juzgado, mediador
  descripcion        String  @db.Text
  resultado          String? @db.Text
  documentoUrl       String?

  requiereFollowUp   Boolean   @default(false)
  fechaFollowUp      DateTime? // → genera alerta FOLLOW_UP
  followUpCompletado Boolean   @default(false)

  createdAt DateTime @default(now())

  caso    CasoRestructuracion @relation(fields: [casoId], references: [id])
  deuda   DeudaBancaria?      @relation(fields: [deudaId], references: [id])
  usuario Usuario             @relation("IntervencionesCreadas", fields: [usuarioId], references: [id])

  @@index([casoId])
  @@index([casoId, tipoIntervencion])
  @@index([deudaId])
  @@index([fechaFollowUp])
}

model HonorarioCRP {
  id     String @id @default(cuid())
  casoId String

  tipoServicio      CRPTipoServicio
  etapa             String          // "Negociación Banco Galicia"
  honorarioPactado  Decimal         @db.Decimal(14, 2)
  honorarioVariable Decimal?        @db.Decimal(14, 2)
  criterioVariable  String?         // "10% del ahorro neto obtenido"

  montoFacturado Decimal       @db.Decimal(14, 2) @default(0)
  montoPercibido Decimal       @db.Decimal(14, 2) @default(0)
  // saldo → calculado: montoFacturado - montoPercibido
  estadoPago     CRPEstadoPago @default(PENDIENTE)
  fechaVencimiento DateTime?   // → genera alerta HONORARIO_VENCIDO

  observaciones String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  caso CasoRestructuracion @relation(fields: [casoId], references: [id])

  @@index([casoId])
  @@index([casoId, estadoPago])
  @@index([fechaVencimiento])
}

model AlertaCRP {
  id                String @id @default(cuid())
  casoId            String
  deudaId           String?
  usuarioAsignadoId String?

  tipoAlerta  CRPTipoAlerta
  fechaAlerta DateTime
  descripcion String
  prioridad   CRPPrioridadAlerta @default(MEDIA)
  estado      CRPEstadoAlerta    @default(PENDIENTE)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  caso            CasoRestructuracion @relation(fields: [casoId], references: [id])
  deuda           DeudaBancaria?      @relation(fields: [deudaId], references: [id])
  usuarioAsignado Usuario?            @relation("AlertasAsignadas", fields: [usuarioAsignadoId], references: [id])

  @@index([casoId])
  @@index([casoId, estado])
  @@index([usuarioAsignadoId, estado])
  @@index([fechaAlerta, estado])
  @@index([prioridad, estado])
}

// ============================================
// ESPECIALIDADES — Contenido (CMS futuro)
// ============================================

model Especialidad {
  id               String   @id @default(cuid())
  nombre           String
  slug             String   @unique
  descripcionCorta String
  descripcionLarga String   @db.Text
  icono            String?
  problemasComunes String[]
  orden            Int      @default(0)
  activo           Boolean  @default(true)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}
